\documentclass[a4paper,twoside,openany]{book}

% ========== CONFIGURAZIONE GEOMETRIA ==========
\usepackage[a4paper,margin=2cm]{geometry}

% ========== PACCHETTI LINGUISTICI E CODIFICA ==========
\usepackage[italian]{babel}
\usepackage[italian=guillemets]{csquotes}
\usepackage{hyphenat}
\hyphenation{
	mate-mati-ca
	re-cu-pe-ra-re
	com-pe-ten-za
	intel-li-gen-za
	cara-tte-ri-sti-che
	abi-li-tà
	in-can-te-si-mo
	at-tac-co
	di-fe-sa
	per-so-nag-gio
	av-ven-tu-ra
	espe-rien-za
	equi-pag-gia-men-to
}

% ========== PACCHETTI GRAFICI E COLORI ==========
\usepackage{xcolor}

% Definizione colori del tema OBSS
\definecolor{OBSSnavyblue}{RGB}{0,0,128}
\definecolor{OBSSprussia}{RGB}{0, 49, 83}
\definecolor{OBSSblue}{RGB}{30,84,131}
\definecolor{OBSSgold}{RGB}{255,215,0}
\definecolor{OBSSpurple}{RGB}{88,57,131}
\definecolor{lightgray}{gray}{0.95}
\definecolor{LightCyan}{RGB}{0,191,255}
\definecolor{SlateGray}{RGB}{112,128,144}
\definecolor{Lavender}{RGB}{230,230,250}
\definecolor{Coral}{RGB}{255,127,80}
\definecolor{Tan}{RGB}{210,180,140}
\definecolor{LightGreen}{RGB}{34,139,34}
\definecolor{Mauve}{RGB}{221,160,221}

% ========== PACCHETTI TIPOGRAFICI ==========
\usepackage{fontspec}
\setmainfont{AtkinsonHyperlegibleNext-Regular.ttf}[
Path=./fonts/,
BoldFont=AtkinsonHyperlegibleNext-Bold.ttf,
ItalicFont=AtkinsonHyperlegibleNext-RegularItalic.ttf,
BoldItalicFont=AtkinsonHyperlegibleNext-BoldItalic.ttf,
Ligatures=TeX
]

\usepackage{microtype}
% microtype migliora la qualità tipografica

% ========== PACCHETTI LAYOUT E SPAZIATURA ==========
\usepackage{setspace}
\usepackage{ragged2e}
\usepackage{quoting,enumitem}

% ========== PACCHETTI MATEMATICI E SCIENTIFICI ==========
\usepackage{amssymb,siunitx}

% ========== PACCHETTI TABELLE ==========
\usepackage{booktabs,multirow}
\usepackage{xltabular,tabularx}
\usepackage{colortbl}
\usepackage{hhline}
\usepackage{multicol,array}

% ========== PACCHETTI GRAFICI E FIGURE ==========
\usepackage{graphics,adjustbox,svg}
\usepackage{caption}
\usepackage{wrapfig}
\usepackage{tikz}
\usetikzlibrary{shadows,shapes.misc,calc}

% ========== PACCHETTI BOX E CORNICI ==========
\usepackage{tcolorbox}
\tcbuselibrary{skins,breakable,theorems}
\usepackage[framemethod=TikZ]{mdframed}

% ========== PACCHETTI BIBLIOGRAFIA E INDICI ==========
\usepackage[backend=bibtex]{biblatex}
\addbibresource{bibliografia.bib}
\usepackage{makeidx,imakeidx}

% ========== PACCHETTI VARI ==========
\usepackage{soul}
\usepackage{pdfpages}
\usepackage{etoolbox}
\usepackage[absolute,overlay]{textpos}
\usepackage{url}
\def\UrlBreaks{\do\/\do-\do_\do.\do:\do=\do&}
\usepackage{varioref}
\usepackage{fontawesome5}


% ========== CONFIGURAZIONI GENERALI ==========
\setcounter{secnumdepth}{-1}
\setcounter{tocdepth}{3}
\raggedbottom
\sloppy
\DeclareMathSizes{11}{11}{8}{6}

% Configurazione XeTeX per l'italiano
\XeTeXlinebreaklocale "it"
\XeTeXlinebreakskip = 0pt plus 1pt

% ========== CONFIGURAZIONE TCOLORBOX ==========
\tcbset{colback=brown!10, fonttitle=\scshape}

% ========== CONFIGURAZIONE INDICI ==========
% Macro per contare le occorrenze negli indici
\def\CountIndexOccurrences#1{%
	\expandafter\newcount\csname #1\endcsname%
	\def\indexentry##1##2{\expandafter\advance\csname #1\endcsname 1}%
	\IfFileExists{#1.idx}{\input{#1.idx}}{}%
}

% Inizializzazione contatori indici
\CountIndexOccurrences{OBSSv2}
\CountIndexOccurrences{Incantesimi}
\CountIndexOccurrences{Mostruario}
\CountIndexOccurrences{Tabelle}
\CountIndexOccurrences{OggettiMagici}
\CountIndexOccurrences{Abilita}

% Macro per visualizzare il totale delle voci
\def\TotalBox#1{\vfill%
	\fbox{Ci sono \expandafter\the\csname #1\endcsname\ voci in questo indice}\par}

% Creazione degli indici
\makeindex[columns=1, title=Indice Analitico, intoc=true]
\makeindex[columns=1, name=Tabelle, title=Elenco delle Tabelle, intoc=true]
\makeindex[columns=1, name=Incantesimi, title=Elenco degli Incantesimi, intoc=true]
\makeindex[columns=1, name=Mostruario, title=Elenco dei Mostri, intoc=true]
\makeindex[columns=1, name=OggettiMagici, title=Elenco degli Oggetti Magici, intoc=true]
\makeindex[columns=1, name=Abilita, title=Elenco delle Abilità, intoc=true]

% ========== CONFIGURAZIONE INTESTAZIONI ==========

\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}
\fancyhead[LE,RO]{\leftmark}
\fancyfoot[C]{\thepage}
\renewcommand{\sectionmark}[1]{\markboth{#1}{}}

\fancypagestyle{plain}{%
	\fancyhf{}
	\fancyhead[RO]{%
		\rotatebox{90}{
			\begin{tikzpicture}[overlay,remember picture]
				\node[
				fill=lightgray,
				text=black,
				font=\footnotesize,
				inner ysep=12pt,
				inner xsep=20pt,
				rounded rectangle,
				anchor=east,
				minimum width=7cm,
				xshift=-60mm,
				yshift=-21mm,
				text height=0.4cm
				] at ($ (current page.north east) + (-1cm,-0cm) + (-4*\thesection cm,0cm) $)
				{\sffamily\itshape\small\nouppercase{\leftmark}};
			\end{tikzpicture}
		}
	}
	\fancyhead[LE]{%
		\rotatebox{90}{
			\begin{tikzpicture}[overlay,remember picture]
				\node[
				fill=lightgray,
				text=black,
				font=\footnotesize,
				inner ysep=12pt,
				inner xsep=20pt,
				rounded rectangle,
				anchor=east,
				minimum width=7cm,
				xshift=-60mm,
				yshift=-4mm,
				text height=0.4cm
				] at ($ (current page.north west) + (1cm,0cm) + (-4*\thesection cm,0cm) $)
				{\sffamily\itshape\small\nouppercase{\leftmark}};
			\end{tikzpicture}
		}
	}
	\renewcommand{\headrulewidth}{0pt}
	\renewcommand{\footrulewidth}{0pt}
	\fancyfoot[C]{\thepage}
}
\pagestyle{plain}

% ----- DEFINIZIONI PER MARGINI -----
\def\changemargin#1#2{\list{}{\rightmargin#2\leftmargin#1}\item[]}
\let\endchangemargin=\endlist

% ========== CONFIGURAZIONE TITOLI ==========
\usepackage{titlesec}

\titleformat{\chapter}[display]
{\normalfont\Huge\bfseries\sffamily\color{OBSSblue}}
{\textcolor{OBSSgold}{\chaptertitlename\ \thechapter}}
{2ex}
{\centering}

\titleformat{\section}
{\normalfont\Large\bfseries\sffamily\color{OBSSblue}}
{\thesection}
{1em}
{}
[\textcolor{OBSSgold}{\titlerule[0.8pt]}]

\titleformat{\subsection}
{\normalfont\large\bfseries\sffamily\color{OBSSblue}}
{\thesubsection}
{1em}
{}

\titlespacing{\chapter}{0pt}{0pt}{20pt}
\titlespacing{\section}{0pt}{10pt}{5pt}
\titlespacing{\subsection}{0pt}{8pt}{4pt}
\titlespacing{\subsubsection}{0pt}{6pt}{3pt}

% ========== AMBIENTI PERSONALIZZATI ==========
\newtcolorbox{narratore}[1][Narratore]{
	enhanced,
	colback=OBSSblue!8,
	colframe=OBSSblue,
	boxrule=1.2pt,
	arc=4mm,
	drop shadow={shadow xshift=1mm, shadow yshift=-1mm, opacity=0.4, shadow scale=1.05},
	title={\textbf{\textcolor{white}{\large \faBook} #1}},
	fonttitle=\sffamily\bfseries\large,
	colbacktitle=OBSSblue,
	coltitle=white,
	attach boxed title to top left={yshift=-2.5mm, xshift=3mm},
	boxed title style={boxrule=0pt, colframe=white, arc=4mm,
		drop shadow={shadow xshift=0.3mm, shadow yshift=-0.3mm, opacity=0.2}
	},
	left=3mm, right=3mm, top=4mm, bottom=2mm,
	before skip=\baselineskip, after skip=\baselineskip,
}

\newtcolorbox{giocatore}[1][Giocatore]{
	enhanced,
	breakable,
	colback=OBSSpurple!8,
	colframe=OBSSpurple,
	boxrule=1.2pt,
	arc=4mm,
	drop shadow={shadow xshift=1mm, shadow yshift=-1mm, opacity=0.4, shadow scale=1.05},
	title={\textbf{\textcolor{white}{\large $\dagger$} #1}},
	fonttitle=\sffamily\bfseries\large,
	colbacktitle=OBSSpurple,
	coltitle=white,
	attach boxed title to top left={yshift=-2.5mm, xshift=3mm},
	boxed title style={boxrule=0pt, colframe=white, arc=4mm,
		drop shadow={shadow xshift=0.3mm, shadow yshift=-0.3mm, opacity=0.2}
	},
	left=3mm, right=3mm, top=4mm, bottom=2mm,
	before skip=\baselineskip, after skip=\baselineskip,
}

\newtcolorbox{enfasi}{
	enhanced,
	colback=OBSSgold!8,
	colframe=OBSSgold,
	boxrule=1.2pt,
	arc=4mm,
	drop shadow={shadow xshift=0.3mm, shadow yshift=-0.3mm, opacity=0.2},
	left=3mm, right=3mm, top=2mm, bottom=2mm,
	before upper={\hyphenpenalty=10000\exhyphenpenalty=10000},
	before skip=\baselineskip, after skip=\baselineskip,
}

% ========== COMANDI PERSONALIZZATI ==========
\newcommand{\OBSSseparator}{%
	\begin{center}%
		\begin{tikzpicture}%
			\draw[OBSSgold, line width=1pt] (-2,0) -- (-0.5,0);%
			\node[circle, fill=OBSSgold, minimum size=4mm] at (0,0) {};%
			\draw[OBSSgold, line width=1pt] (0.5,0) -- (2,0);%
		\end{tikzpicture}%
	\end{center}%
}

\newcommand{\FatePoint}{\textcolor{OBSSgold}{$\bullet$}}
\newcommand{\FatePoints}[1]{%
	\textcolor{OBSSgold}{%
		\foreach \n in {1,...,#1}{$\bullet$\,}%
	}%
}

%\NewDocumentCommand{\feat}{m}{
%	\noindent\rule{\linewidth}{2pt}
%	\index[Abilita]{#1}\hypertarget{#1}{}\label{#1}
%	\vspace{-5.5mm}
%	\begin{tcolorbox}[
%%		colback=OBSSgold!12, colframe=OBSSgold,
%		boxrule=1.5pt, arc=3pt, boxsep=1pt,
%		left=6pt, right=6pt, top=3pt, bottom=3pt
%		]
%		\centering\textbf{\textcolor{OBSSgold!80!black}{#1}}
%	\end{tcolorbox}
%	\pdfbookmark[3]{#1}{#1}
%	\vspace{1mm}\noindent
%}

\NewDocumentCommand{\feat}{m}{
	\noindent\rule{\linewidth}{2pt}
	\index[Abilita]{#1}\hypertarget{#1}{}\label{#1}
	\vspace{-5.5mm}
	\begin{center}\textbf{\textcolor{OBSSgold!90!black}{#1}}\end{center}
	\pdfbookmark[3]{#1}{#1}
	\vspace{-1mm}\noindent
}

\NewDocumentCommand{\incantesimo}{m}{
	\noindent\rule{\linewidth}{2pt}
	\index[Incantesimi]{#1}\hypertarget{#1}{}\label{#1}
	\vspace{-5.5mm}
	\begin{center}\textbf{\textcolor{OBSSgold!90!black}{#1}}\end{center}
	\pdfbookmark[3]{#1}{#1}
	\vspace{-1mm}\noindent
}

\NewDocumentCommand{\mostro}{m}{
	\noindent\rule{\linewidth}{2pt}
	\index[Mostruario]{#1}\hypertarget{#1}{}\label{#1}
	\vspace{-5.5mm}
	\begin{center}\textbf{\textcolor{OBSSgold!90!black}{#1}}\end{center}
	\pdfbookmark[3]{#1}{#1}
	\vspace{-1mm}\noindent
}

\NewDocumentCommand{\oggettomagico}{m}{
	\noindent\rule{\linewidth}{2pt}
	\index[OggettiMagici]{#1}\hypertarget{#1}{}\label{#1}
	\vspace{-5.5mm}
	\begin{center}\textbf{\textcolor{OBSSgold!80!black}{#1}}\end{center}
	\pdfbookmark[3]{#1}{#1}
	\vspace{-1mm}\noindent
}



% ========== SISTEMA TABELLE COLORATE ==========
\newcommand{\obsscurrentcolor}{Coral}
\newcommand{\obsssetcolor}[1]{\renewcommand{\obsscurrentcolor}{#1}}

% Comandi per cambiare colore
\newcommand{\obssgrey}{\obsssetcolor{SlateGray}}
\newcommand{\obsspurple}{\obsssetcolor{Mauve}}
\newcommand{\obssblue}{\obsssetcolor{LightCyan}}
\newcommand{\obssgreen}{\obsssetcolor{LightGreen}}
\newcommand{\obsscoral}{\obsssetcolor{Coral}}


% ========== HYPERREF E BOOKMARK ==========
% Importante: hyperref deve essere caricato per ultimo (quasi)
\usepackage[
unicode,
pdfencoding=auto,
bookmarks=true,
colorlinks=true,
linkcolor=OBSSblue,
citecolor=OBSSpurple,
urlcolor=OBSSblue,
filecolor=OBSSblue,
anchorcolor=OBSSblue,
pdftitle={OBSS - Old Bell School System},
pdfsubject={Gioco di Ruolo Fantasy},
pdfauthor={Andres Zanzani},
pdfkeywords={GDR, Fantasy, Gioco di Ruolo, OBSS},
pdfcreator={XeLaTeX},
pdfproducer={TexStudio on Debian},
pdfborder={0 0 0},
breaklinks=true,
bookmarksopenlevel=1,
bookmarksnumbered=true,
bookmarksopen=true
]{hyperref}


\usepackage{bookmark}
% bookmark deve essere caricato dopo hyperref

% ========== INIZIO DOCUMENTO ==========
\begin{document}
